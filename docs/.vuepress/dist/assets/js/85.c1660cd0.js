(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{496:function(a,t,s){"use strict";s.r(t);var e=s(17),n=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"使用canal同步mysql数据到es"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用canal同步mysql数据到es"}},[a._v("#")]),a._v(" 使用canal同步mysql数据到es")]),a._v(" "),t("h2",{attrs:{id:"使用阿里云ecs实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用阿里云ecs实例"}},[a._v("#")]),a._v(" 使用阿里云ECS实例")]),a._v(" "),t("h2",{attrs:{id:"启动es"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动es"}},[a._v("#")]),a._v(" 启动ES")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建网络")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" network create my_default\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" elasticsearch "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9200")]),a._v(":9200 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9300")]),a._v(":9300 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"discovery.type=single-node"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xpack.security.enabled=false"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"ES_JAVA_OPTS=-Xmx512m -Xms512m"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--net")]),a._v(" my_default "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    docker.elastic.co/elasticsearch/elasticsearch:7.10.2\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 进入容器安装 ik 分词器")]),a._v("\n./bin/elasticsearch-plugin "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.10.2/elasticsearch-analysis-ik-7.10.2.zip\n")])])]),t("h2",{attrs:{id:"启动-kibana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动-kibana"}},[a._v("#")]),a._v(" 启动 kibana")]),a._v(" "),t("p",[a._v("默认可以直接连接容器名为 elasticsearch 的 es")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" kibana "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--net")]),a._v(" my_default "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5601")]),a._v(":5601 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    docker.elastic.co/kibana/kibana:7.10.2\n")])])]),t("ul",[t("li",[a._v("创建索引")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('PUT es_test?include_type_name=true\n{\n\n    "settings" : {\n      "index" : {\n        "number_of_shards" : "5",\n        "number_of_replicas" : "1"\n      }\n    },\n    "mappings" : {\n        "_doc" : {\n            "properties" : {\n              "count": {\n                   "type": "text"\n               },\n              "id": {\n                   "type": "integer"\n               },\n               "name": {\n                    "type" : "text",\n                    "analyzer": "ik_smart"\n                },\n                "color" : {\n                    "type" : "text"\n                }\n            }\n        }\n    }\n}\n')])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('POST _analyze\n{\n  "analyzer":"ik_max_word",\n  "text": "南京市长江大桥"\n}\n\nGET /_cat/indices\n\n\nGET es_test/_search\n')])])]),t("h2",{attrs:{id:"启动mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动mysql"}},[a._v("#")]),a._v(" 启动mysql")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-itd")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" mysql-test "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),a._v(":3306 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--network")]),a._v(" my_default --network-alias mysql "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_ROOT_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root123 mysql:5.7\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" mysql-test "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v("\n\nmysql "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-u")]),a._v(" root "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v("\n\nshow databases"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\nCREATE DATABASE es"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查看是否开启binlog")]),a._v("\nSHOW VARIABLES LIKE "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%log_bin%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#开启配置binlog日志")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# 在centos中mysql的配置文件一般都在/etc/mysql目录下，如果不在可以通过 find / -name "my.cnf" 查找')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vi")]),a._v(" /etc/mysql/my.cnf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加")]),a._v("\nserver-id"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\nlog_bin "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" /var/lib/mysql/mysql_bin\nbinlog_format "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" ROW\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重启 mysql")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# MySQL添加canal用户并授权,canal的原理是模拟自己为mysql slave，所以需要mysql slave的相关权限")]),a._v("\nCREATE "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("USER")]),a._v(" canal IDENTIFIED BY "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'canal'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\nGRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'canal'")]),a._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\nFLUSH PRIVILEGES"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 校验用户对应权限")]),a._v("\nshow master status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),t("h2",{attrs:{id:"安装jdk"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装jdk"}},[a._v("#")]),a._v(" 安装JDK")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" java-1.8.0-openjdk-devel.x86_64\n")])])]),t("p",[a._v("配置环境变量")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("vim ~/.bash_profile\n\n# 添加\nexport JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.362.b08-1.el7_9.x86_64\nexport CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar\nexport PATH=$PATH:$JAVA_HOME/bin\n\n#使生效\nsource ~/.bash_profile\n")])])]),t("h2",{attrs:{id:"安装canal"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装canal"}},[a._v("#")]),a._v(" 安装canal")]),a._v(" "),t("ul",[t("li",[a._v("安装deployer")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("wget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.deployer-1.1.5.tar.gz\nmkdir canal.deployer-1.1.5\ntar -zxvf canal.deployer-1.1.5.tar.gz -C canal.deployer-1.1.5\n# 修改配置\nvi conf/example/instance.properties\n")])])]),t("p",[a._v("需要修改的内容")]),a._v(" "),t("div",{staticClass:"language-text extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("canal.instance.master.address=8.222.134.206:3306\n\ncanal.instance.dbUsername=root\ncanal.instance.dbPassword=root123\n")])])]),t("p",[a._v("启动")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("./bin/startup.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" logs/canal/canal.log\n")])])]),t("ul",[t("li",[a._v("安装adapter")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("wget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.adapter-1.1.5.tar.gz\nmkdir canal.adapter-1.1.5\ntar -zxvf canal.adapter-1.1.5.tar.gz -C canal.adapter-1.1.5\n\n# 修改配置\nvi conf/application.yml\n")])])]),t("p",[a._v("需要改动的配置")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("  srcDataSources:\n    defaultDS:\n      url: jdbc:mysql://8.222.134.206:3306/es?useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=false\n      # url: jdbc:mysql://8.222.134.206:3306/es?useUnicode=true\n      username: canal\n      password: canal\n\n      - name: es7\n        hosts: 8.222.134.206:9200\n        properties:\n          mode: rest\n          # security.auth: test:123456 #  only used for rest mode\n          cluster.name: elasticsearch\n")])])]),t("p",[a._v("同样的方式，修改conf/es/*.yml文件，定义MySQL数据到ES数据的映射字段。")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('dataSourceKey: defaultDS\ndestination: example\ngroupId: g1\nesMapping:\n  _index: es_test\n  _type: _doc\n  _id: _id\n  sql: "select t.id as _id,t.id,t.count,t.name,t.color from es_test t"\n  commitBatch: 3000\n')])])]),t("ul",[t("li",[a._v("启动Canal-adapter服务，并查看日志。")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("./bin/startup.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" logs/adapter/adapter.log\n")])])]),t("p",[a._v("Q：启动Canal-adapter时，adapter.log日志显示异常，如何解决？错误日志为：java.lang.RuntimeException: java.lang.RuntimeException: java.lang.ClassCastException: com.alibaba.druid.pool.DruidDataSource cannot be cast to com.alibaba.druid.pool.DruidDataSource")]),a._v(" "),t("p",[a._v("at com.alibaba.otter.canal.client.adapter.es7x.ES7xAdapter.init(ES7xAdapter.java:54) ~[client-adapter.es7x-1.1.5-jar-with-dependencies.jar:na]")]),a._v(" "),t("p",[a._v("A：将canal.adapter-1.1.5\\plugin下的client-adapter.es7x-1.1.5-jar-with-dependencies.jar替换为canal-1.1.5-alpha-2版本下的对应文件。")]),a._v(" "),t("h2",{attrs:{id:"验证增量数据同步"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证增量数据同步"}},[a._v("#")]),a._v(" 验证增量数据同步")]),a._v(" "),t("p",[a._v("MySQL数据库中，新增、修改或删除数据库中es_test表的数据。")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("insert `es_test`(`count`,`id`,`name`,`color`) values('11',2,'canal_test2','red');\n")])])]),t("h1",{attrs:{id:"references"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[a._v("#")]),a._v(" references")]),a._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/alibaba/canal",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/alibaba/canal"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://help.aliyun.com/zh/es/use-cases/use-canal-to-synchronize-mysql-data-to-alibaba-cloud-elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://help.aliyun.com/zh/es/use-cases/use-canal-to-synchronize-mysql-data-to-alibaba-cloud-elasticsearch"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://weikeqin.com/2018/05/16/canal-notes/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://weikeqin.com/2018/05/16/canal-notes/"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_44606481/article/details/133344235",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://blog.csdn.net/weixin_44606481/article/details/133344235"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/alibaba/canal/issues/3466#issuecomment-1049509123",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/alibaba/canal/issues/3466#issuecomment-1049509123"),t("OutboundLink")],1)]),a._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/medcl/elasticsearch-analysis-ik/issues/848",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/medcl/elasticsearch-analysis-ik/issues/848"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=n.exports}}]);