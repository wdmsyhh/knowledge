(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{302:function(s,a,t){s.exports=t.p+"assets/img/ansible_common_patterns.745746f5.png"},342:function(s,a,t){"use strict";t.r(a);var e=t(14),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("title: Ansible\nspeaker: Neil Chen")]),s._v(" "),a("slide"),s._v(" "),a("h1",{attrs:{id:"ansible"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ansible"}},[s._v("#")]),s._v(" Ansible")]),s._v(" "),a("p",[s._v("Neil Chen")]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("ul",[a("li",[s._v("Ansible 是当前流行的自动化运维工具，可用来配置系统、部署软件等，默认使用 SSH 协议实现管理节点与远程节点的通信。")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://ansible.leops.cn/basic/Introduction/",target:"_blank",rel:"noopener noreferrer"}},[s._v("入门学习资料"),a("OutboundLink")],1),s._v("，读完 1-15 章（注意：该资料使用的是 ansible 2.9.6，比我们新，其例子中部分 inventory 使用的是 yaml 格式定义的，我们目前使用的是 ini 格式，学习的时候统一使用 ini 格式）。")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html#plugins-in-ansible-builtin",target:"_blank",rel:"noopener noreferrer"}},[s._v("内置模块学习资料"),a("OutboundLink")],1),s._v("，大概了解一下，需要用的时候再详细查看用法。")])]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("p",[s._v("我们目前使用的是 Ansible 2.7.6，使用 pip 安装。")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-U")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ansible")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.7")]),s._v(".6\n")])])]),a("slide"),s._v(" "),a("h2",{attrs:{id:"inventory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#inventory"}},[s._v("#")]),s._v(" Inventory")]),s._v(" "),a("p",[s._v("定义了被管理的主机列表或主机组，默认文件为 /etc/ansible/hosts，可通过 "),a("code",[s._v("-i")]),s._v(" 选项指定自定义的 inventory 文件。")]),s._v(" "),a("ul",[a("li",[s._v("主机、组以及变量的定义。")])]),s._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主机、主机变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("192.168.1.1 ansible_ssh_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("user")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 组")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mongodb-single")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n192.168.1.1\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 组变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mongodb-single:vars")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("mongodbPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/data/mongodb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 组嵌套")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("databases:children")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nmongodb-single\n")])])]),a("slide"),s._v(" "),a("h2",{attrs:{id:"patterns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#patterns"}},[s._v("#")]),s._v(" Patterns")]),s._v(" "),a("p",[s._v("定位主机和组，即在哪些主机或组中执行命令，格式为 "),a("code",[s._v('ansible [-i inventory] <pattern> -m <module_name> -a "<module options>"')]),s._v("，常用的 patterns 如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(302),alt:"patterns"}})]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"ad-hoc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ad-hoc"}},[s._v("#")]),s._v(" Ad-Hoc")]),s._v(" "),a("p",[s._v("使用 Ansible 命令行工具来执行简单的、一次性的命令，比如：")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出本机 /home 下的目录，需在 inventory test.ini 中定义 host 为 127.0.0.1")]),s._v("\nansible "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" test.ini "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" shell "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ls -al /home"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝 test.ini 到 /tmp 目录")]),s._v("\nansible "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" test.ini "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" copy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"src=test.ini dest=/tmp"')]),s._v("\n")])])]),a("slide"),s._v(" "),a("h2",{attrs:{id:"playbooks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#playbooks"}},[s._v("#")]),s._v(" Playbooks")]),s._v(" "),a("ul",[a("li",[s._v("Playbooks 是 Ansible 指令的集合，使用 YAML 格式，定义了在远程机器上执行命令的策略，命令行工具为 ansible-playbook，非常适用于复杂应用的部署。")]),s._v(" "),a("li",[s._v("命令格式为 "),a("code",[s._v("ansible-playbook playbooks/<playbook_name> -i inventories/<invnetory_name>")]),s._v("，可使用 "),a("code",[s._v("-l")]),s._v(" 以限制在指定的 host 上执行，"),a("code",[s._v("-t")]),s._v(" 只执行指定 tag 相关的 tasks，"),a("code",[s._v("-e")]),s._v(" 指定额外的变量。")])]),s._v(" "),a("h3",{attrs:{id:"基本格式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本格式"}},[s._v("#")]),s._v(" 基本格式")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{ host }}'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("vars")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("diskName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sdc'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("diskSize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{{ dataDiskSize }}'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountFolder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'app'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" create docker folder\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /app/docker\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" directory\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" link docker\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /app/docker\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/docker\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" link\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" initDisk\n")])])]),a("slide"),s._v(" "),a("h3",{attrs:{id:"常用字段介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用字段介绍"}},[s._v("#")]),s._v(" 常用字段介绍")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("hosts 定义了一个或多个主机或组，以冒号分隔。")])]),s._v(" "),a("li",[a("p",[s._v("remote_user 指定执行该 playbook 的用户的名称。")])]),s._v(" "),a("li",[a("p",[s._v("vars 定义了 playbook 中需要使用的变量，可直接在 playbook 中配置，也可以从 inventory 的主机或组的变量中获取。")])]),s._v(" "),a("li",[a("p",[s._v("tasks 定义了 playbook 需要执行的任务列表，每个 tasks 都会执行一个 module（比如 file、apt 等），tasks 按顺序依次执行，其格式如下：")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" tasks name\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" MODULE_NAME "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" MODULE_PARAMETER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("roles 主要用于封装 playbook 以方便复用。")])])]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"roles-include-语句"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#roles-include-语句"}},[s._v("#")]),s._v(" Roles & Include 语句")]),s._v(" "),a("p",[s._v("Roles 和 Include 语句结合使用可使　playbook 保持简洁，实现 playbook 的复用。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("常用的 include 语句：")]),s._v(" "),a("ul",[a("li",[s._v("include：引用其他 tasks。")]),s._v(" "),a("li",[s._v("include_role：引用其他 role。")])])]),s._v(" "),a("li",[a("p",[s._v("role 基于已知文件结构自动加载某些 vars_files、tasks 的方法，常用目录结构如下：")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("roles/\n  common/\n    defaults/\n    tasks/\n    files/\n    templates/\n")])])])]),s._v(" "),a("li",[a("p",[s._v("role 各目录的内容如下：")]),s._v(" "),a("ul",[a("li",[s._v("defaults：role 的默认变量，可在 tasks、templates 中引用，目录中必须包含 main.yml。")]),s._v(" "),a("li",[s._v("tasks：role 要执行的主要任务列表，可使用 include 引用其他 task，目录中必须包含 main.yml，")]),s._v(" "),a("li",[s._v("files：role 要部署的文件，该目录主要用于存放内容固定不变的系统配置文件、脚本等。")]),s._v(" "),a("li",[s._v("templates：role 要部署的模板，可读取 inventory、playbook、role 中设置的变量，遵循 Jinja2 模板语法，通常用来存放要部署的软件的配置文件。")])])])]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"variables"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#variables"}},[s._v("#")]),s._v(" Variables")]),s._v(" "),a("ul",[a("li",[s._v("变量名可以为字母、数字以及下划线，并且始终应该以字母开头。")]),s._v(" "),a("li",[s._v("变量的使用遵循 Jinja2 模板语法。")]),s._v(" "),a("li",[s._v("可在 inventory、playbook、role 中定义变量，也可以在 ansible-playbook 命令行中使用 "),a("code",[s._v("-e")]),s._v(" 指定变量。")]),s._v(" "),a("li",[s._v("可通过 register 关键字注册变量，可在后续的 tasks 中引用该变量。")]),s._v(" "),a("li",[s._v("变量的优先级参考"),a("a",{attrs:{href:"https://ansible.leops.cn/basic/Variables/#_3",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("li",[s._v("Ansible 内置变量参考"),a("a",{attrs:{href:"https://ansible.leops.cn/basic/Variables/#_7",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),a("OutboundLink")],1),s._v("。")])]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"条件判断与循环"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#条件判断与循环"}},[s._v("#")]),s._v(" 条件判断与循环")]),s._v(" "),a("ul",[a("li",[s._v("Ansible 使用 when 语句后的表达式来判断该步骤是否执行。")]),s._v(" "),a("li",[s._v("Ansible 使用 loop 和 with_*（比如：with_items）实现循环，以简化重复任务的写法。")])]),s._v(" "),a("slide"),s._v(" "),a("h2",{attrs:{id:"thanks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#thanks"}},[s._v("#")]),s._v(" Thanks")])],1)}),[],!1,null,null,null);a.default=n.exports}}]);